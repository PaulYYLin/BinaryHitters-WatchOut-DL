version: '3.8'

services:
  fall-detector:
    build:
      context: .
      dockerfile: Dockerfile

    container_name: fall-detection-system

    # Camera device access (USB webcam)
    devices:
      - /dev/video0:/dev/video0

    # Volume mounts
    volumes:
      # Logs directory (persistent)
      - ./logs:/app/logs
      # Temporary files (can be tmpfs for performance)
      - /tmp/fall_events:/tmp/fall_events

    # Environment variables (override with .env file)
    env_file:
      - .env

    # Resource limits for edge devices
    deploy:
      resources:
        limits:
          cpus: '2.0'           # Limit to 2 CPU cores
          memory: 512M          # Limit to 512MB RAM
        reservations:
          memory: 256M          # Reserve at least 256MB

    # Use tmpfs for temporary files (faster I/O, saves SD card writes)
    tmpfs:
      - /tmp:size=100M

    # Restart policy
    restart: unless-stopped

    # Network mode (optional, for API access)
    network_mode: bridge

    # Logging configuration (prevent log file bloat)
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

# Optional: Multiple camera support
# Uncomment and modify for multiple cameras
#
#  fall-detector-camera2:
#    build:
#      context: .
#      dockerfile: Dockerfile
#    container_name: fall-detection-camera2
#    devices:
#      - /dev/video1:/dev/video0  # Map camera 1 to container's video0
#    volumes:
#      - ./logs:/app/logs
#    env_file:
#      - .env.camera2
#    deploy:
#      resources:
#        limits:
#          cpus: '2.0'
#          memory: 512M
#    restart: unless-stopped
